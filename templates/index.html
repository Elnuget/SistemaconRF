<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Python - Flask - Reconocimiento Facial</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
</head>
<body>
    <main class="d-flex">
        <div class="container-fluid row m-0 vh-100 justify-content-center align-items-center">
            <div class="card shadow w-50">
                <div class="card-body">
                    {% with messages = get_flashed_messages(with_categories=true) %}
                    {% if messages %}
                        {% for category, message in messages %}
                        <div class="alert alert-{{ category }} alert-dismissible fade show" role="alert">
                            {{ message }}
                            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                        </div>
                        {% endfor %}
                    {% endif %}
                    {% endwith %}

                    <!-- LOGIN NORMAL -->
                    <form action="/login" method="post">
                        <h3 class="text-center">Sistema de Reconocimiento Facial</h3>
                        <h5 class="text-center">Login</h5>
                        <label>Email</label>
                        <input type="email" class="form-control mb-3" name="email" required>
                        <label>Contraseña</label>
                        <input type="password" class="form-control mb-3" name="password" required>
                        <button type="submit" class="btn btn-primary w-100">Acceder</button>
                    </form>

                    <!-- LOGIN CON ROSTRO -->
                    <div class="text-center mt-3">
                        <button type="button" id="startFaceLogin" class="btn btn-secondary w-100">
                            Iniciar sesión con reconocimiento facial
                        </button>
                    </div>

                    <div id="face-login-container" class="text-center mt-3" style="display: none;">
                        <video id="faceLoginWebcam" autoplay playsinline></video>
                        <div id="face-login-status" class="mt-2">No se detecta rostro</div>
                        <button type="button" id="captureFaceLogin" class="btn btn-success mt-3" disabled>
                            Capturar Rostro
                        </button>
                        <div id="closest-match-container" class="mt-3" style="display: none;">
                            <h5>Foto más cercana</h5>
                            <img id="closest-match-image" src="" alt="Closest Match" class="img-fluid rounded">
                        </div>
                    </div>

                    <!-- Sección para mostrar todas las imágenes de usuarios -->
                    <div id="user-images-container" class="text-center mt-3">
                        <h5>Imágenes de Usuarios Registrados</h5>
                        <div id="user-images" class="d-flex flex-wrap justify-content-center"></div>
                    </div>

                    <script>
                        const startFaceLoginButton = document.getElementById('startFaceLogin');
                        const faceLoginContainer = document.getElementById('face-login-container');
                        const faceLoginWebcam = document.getElementById('faceLoginWebcam');
                        const captureFaceLoginButton = document.getElementById('captureFaceLogin');
                        const faceLoginStatus = document.getElementById('face-login-status');
                        const closestMatchContainer = document.getElementById('closest-match-container');
                        const closestMatchImage = document.getElementById('closest-match-image');
                        const userImagesContainer = document.getElementById('user-images');

                        let faceLoginStream = null;
                        let userImages = []; // Array global de {id, image}

                        // Al hacer clic en "Iniciar sesión con reconocimiento facial"
                        startFaceLoginButton.addEventListener('click', async () => {
                            try {
                                faceLoginStream = await navigator.mediaDevices.getUserMedia({ video: true });
                                faceLoginWebcam.srcObject = faceLoginStream;
                                faceLoginContainer.style.display = 'block';
                                
                                // Cargamos primero las imágenes de usuarios
                                await loadUserImages();
                                // Iniciamos bucle de detección
                                startFaceDetection();
                            } catch (err) {
                                console.error('Error al acceder a la cámara:', err);
                                alert('Error al acceder a la cámara');
                            }
                        });

                        // Descarga de las imágenes de usuarios
                        async function loadUserImages() {
                            try {
                                const response = await fetch('/get-user-images');
                                userImages = await response.json(); // Array de objetos: [{id, image}, ...]
                                displayUserImages(userImages);
                            } catch (error) {
                                console.error('Error al cargar las imágenes:', error);
                            }
                        }

                        // Muestra las miniaturas de cada imagen en la parte de abajo
                        function displayUserImages(images) {
                            userImagesContainer.innerHTML = '';
                            images.forEach(obj => {
                                const imgElement = document.createElement('img');
                                imgElement.src = `data:image/jpeg;base64,${obj.image}`;
                                imgElement.classList.add('img-thumbnail', 'm-1');
                                imgElement.style.width = '100px';
                                imgElement.style.height = '100px';
                                userImagesContainer.appendChild(imgElement);
                            });
                        }

                        // Bucle de detección continua
                        async function startFaceDetection() {
                            while (faceLoginWebcam.srcObject) {
                                const canvas = document.createElement('canvas');
                                canvas.width = faceLoginWebcam.videoWidth;
                                canvas.height = faceLoginWebcam.videoHeight;
                                canvas.getContext('2d').drawImage(faceLoginWebcam, 0, 0);
                                const faceImage = canvas.toDataURL('image/jpeg');

                                try {
                                    // Llamamos a /detect-face para verificar si hay un rostro
                                    const response = await fetch('/detect-face', {
                                        method: 'POST',
                                        body: JSON.stringify({
                                            image: faceImage,
                                            user_images: userImages
                                        }),
                                        headers: { 'Content-Type': 'application/json' }
                                    });

                                    const result = await response.json();
                                    if (result.face_detected) {
                                        faceLoginStatus.textContent = 'Rostro detectado';
                                        faceLoginStatus.style.color = 'green';
                                        captureFaceLoginButton.disabled = false;

                                        if (result.closest_match) {
                                            closestMatchImage.src = result.closest_match;
                                            closestMatchContainer.style.display = 'block';
                                        }
                                    } else {
                                        faceLoginStatus.textContent = 'No se detecta rostro';
                                        faceLoginStatus.style.color = 'red';
                                        captureFaceLoginButton.disabled = true;
                                        closestMatchContainer.style.display = 'none';
                                    }
                                } catch (error) {
                                    console.error('Error en la detección facial:', error);
                                }

                                // Esperamos 500ms para no saturar el servidor
                                await new Promise(resolve => setTimeout(resolve, 500));
                            }
                        }

                        // Al presionar "Capturar Rostro" hacemos la petición final de login
                        captureFaceLoginButton.addEventListener('click', async () => {
                            const canvas = document.createElement('canvas');
                            canvas.width = faceLoginWebcam.videoWidth;
                            canvas.height = faceLoginWebcam.videoHeight;
                            canvas.getContext('2d').drawImage(faceLoginWebcam, 0, 0);
                            const faceImage = canvas.toDataURL('image/jpeg');

                            try {
                                const response = await fetch('/login-face', {
                                    method: 'POST',
                                    body: JSON.stringify({
                                        image: faceImage,
                                        user_images: userImages
                                    }),
                                    headers: { 'Content-Type': 'application/json' }
                                });

                                const result = await response.json();
                                if (result.success) {
                                    // Redirigimos al home
                                    window.location.href = '/';
                                } else {
                                    alert(result.message || 'No se pudo iniciar sesión con reconocimiento facial');
                                }
                            } catch (error) {
                                console.error('Error en el login facial:', error);
                            } finally {
                                // Parar la cámara
                                if (faceLoginStream) {
                                    faceLoginStream.getTracks().forEach(track => track.stop());
                                }
                                faceLoginContainer.style.display = 'none';
                            }
                        });
                    </script>

                    <!-- Botón de registro -->
                    <form action="/register" method="get">
                        <button type="submit" class="btn btn-success w-100 mt-3">Registrarse</button>
                    </form>

                </div>
            </div>
        </div>
    </main>
</body>
</html>
